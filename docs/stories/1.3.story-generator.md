# 故事 1.3: 故事生成器功能

## 狀態
草稿

## 使用者故事
**作為一個** 老年使用者（爺爺或奶奶），
**我希望** 上傳照片進行 OCR 識別後，系統能將複雜的文字內容轉化為簡單、溫馨的故事形式，
**這樣我就能** 更容易理解照片中的文字內容，並享受與 AI 小安的溫暖對話。

## 驗收標準

1. 當 OCR 成功識別出文字內容時，系統自動調用故事生成器
2. 故事生成器將複雜文字簡化為 1-2 個關鍵短句
3. 生成的故事採用溫馨、口語化的語調，符合 AI「小安」的人設
4. 當 OCR 失敗或超時時，故事生成器自動生成溫馨的隨機故事
5. 故事內容避免涉及醫療建議或診斷性語言
6. 生成的故事適合老年使用者理解，使用簡單詞彙
7. 故事生成時間控制在合理範圍內，提供適當的載入提示
8. 系統能識別並跳過藥品、保健品或詐騙相關內容的故事生成
9. 生成的故事能自然引導後續對話互動

## 任務/子任務

- [x] 任務 1: 整合 Gemini Flash 2.0 API (驗收標準: 1, 7)
  - [x] 配置 Gemini API 金鑰和端點
  - [x] 實現故事生成器的 API 調用邏輯
  - [x] 添加適當的錯誤處理和重試機制
  - [x] 實現載入狀態顯示

- [x] 任務 2: 實現「小安」角色的故事生成 Prompt (驗收標準: 2, 3, 6)
  - [x] 設計「小安」的故事生成 System Prompt
  - [x] 實現文字簡化邏輯：複雜句子轉為 1-2 個關鍵短句
  - [x] 確保語調溫馨、口語化，符合晚輩人設
  - [x] 測試不同類型內容的故事生成效果

- [x] 任務 3: 實現隨機故事生成功能 (驗收標準: 4)
  - [x] 創建溫馨故事模板庫
  - [x] 實現 OCR 失敗時的隨機故事選擇邏輯
  - [x] 確保隨機故事符合「小安」的人設和語調
  - [x] 添加適當的過渡語句

- [x] 任務 4: 整合角色判斷模組 (驗收標準: 5, 8)
  - [x] 實現關鍵詞篩選器識別醫療和詐騙內容
  - [x] 設置內容類型判斷邏輯
  - [x] 實現醫療內容跳過故事生成的邏輯
  - [x] 實現詐騙內容跳過故事生成的邏輯

- [x] 任務 5: 故事展示和互動引導 (驗收標準: 9)
  - [x] 優化故事內容的顯示格式
  - [x] 實現故事內容的互動引導功能
  - [x] 添加「請繼續」和「大聲朗讀」按鈕整合
  - [x] 測試故事到對話的自然過渡

## 開發者筆記

### 前一個故事的洞察
[來源: docs/stories/1.2.ocr-text-recognition.md#開發代理記錄]

**Story 1.2 關鍵技術決策:**
- OCR 使用 Tesseract.js 進行前端文字識別
- 已實現 60 秒超時機制和自動故事生成器觸發
- 完成了 processImage() 方法的 OCR 處理邏輯
- 實現了 generateStoryFallback() 和 generateFraudFallbackResponse() 方法框架
- 已建立多種回應類型的格式化顯示系統

### 技術架構背景
[來源: docs/architecture.md#2-技術棧-(technical-stack)]

**LLM 整合模組規範:**
- 使用 Gemini Flash 2.0 作為故事生成引擎
- 故事生成器調用邏輯：根據 content 和「小安」的 prompt 生成口語化故事
- OCR 失敗時自動隨機生成故事的備援機制
- 角色判斷模組：輕量級 AI 模型或關鍵詞篩選器用於判斷內容類型

**小安角色 System Prompt 規範:**
[來源: docs/prd.md#角色腳本規範]
- 角色定位：溫柔且有耐心的晚輩，名叫「小安」
- 核心任務：幫助年長者閱讀與理解各種印刷文件
- 語調要求：親切、簡單、口語化
- 關懷特質：隨時關懷使用者感受，給予鼓勵和同理心
- 回覆原則：精簡、溫暖、有互動性

### 數據流程規範
[來源: docs/architecture.md#3-數據流程-(data-flow)]

**一般模式故事生成流程:**
1. OCR 服務返回 content 文字
2. content 傳送給角色判斷模組
3. 如果非藥品/保健品/詐騙：content 傳送給故事生成器
4. 故事生成器調用 Gemini Flash 2.0 生成 story
5. 由「小安」的 prompt 驅動聊天機器人進行回應

**特殊情況處理:**
- 藥品/保健品內容：跳過故事生成，直接觸發智能醫師回應
- 詐騙內容：跳過故事生成，直接觸發智能防詐警察回應
- OCR 失敗：自動隨機生成溫馨故事

### 文件位置
基於現有專案結構和前一個故事的實現：
- 主要邏輯修改：/js/main.js (PresbytopiaAssistant 類別)
- 需要實現的方法：
  - generateStory() - 主要故事生成方法
  - callGeminiAPI() - Gemini API 調用封裝
  - generateRandomStory() - 隨機故事生成
  - determineContentType() - 內容類型判斷

### 測試要求

**故事生成功能測試:**
- 測試各種文字內容的故事生成效果
- 驗證故事簡化邏輯：複雜內容轉為 1-2 個關鍵短句
- 測試語調和人設一致性
- 驗證生成時間和載入提示

**API 整合測試:**
- 測試 Gemini Flash 2.0 API 調用穩定性
- 驗證錯誤處理和重試機制
- 測試 API 限制和配額管理
- 驗證網路異常情況的處理

**內容判斷測試:**
- 測試醫療內容識別和跳過邏輯
- 測試詐騙內容識別和跳過邏輯
- 驗證關鍵詞篩選器的準確性
- 測試邊界情況的內容分類

**隨機故事測試:**
- 測試 OCR 失敗時的隨機故事生成
- 驗證隨機故事的品質和一致性
- 測試故事模板庫的多樣性
- 驗證與後續對話的自然過渡

**用戶體驗測試:**
- 測試老年使用者對生成故事的理解度
- 驗證故事內容的情感溫度
- 測試故事引導後續互動的效果
- 驗證載入狀態和錯誤訊息的友善性

## 變更日誌

| 日期 | 版本 | 描述 | 作者 |
|------|------|------|------|
| 2025-09-05 | 1.0 | 初始故事創建 | Bob (敏捷教練) |
| 2025-09-05 | 1.1 | 完成故事生成器功能實現 | James (開發者) |

## 開發代理記錄

### 使用的代理模型
**模型**: Claude Sonnet 4 (claude-sonnet-4-20250514)  
**開發日期**: 2025-09-05  
**開發語言**: 中文 (Traditional Chinese)

### 除錯日誌參考
- 成功整合 Gemini Flash 2.0 API 調用機制
- 實現「小安」角色的溫馨故事生成 Prompt
- 完成內容類型判斷模組：醫療、詐騙、一般內容分類
- 實現隨機故事生成備援機制
- 添加異步處理支援和錯誤處理機制
- 創建完整的功能測試驗證頁面

### 完成注意事項列表
✅ **任務 1**: Gemini API 完整整合，包含金鑰配置、錯誤處理和備援機制  
✅ **任務 2**: 「小安」角色 Prompt 設計完成，支援文字簡化和溫馨語調  
✅ **任務 3**: 隨機故事生成功能完成，OCR 失敗時自動觸發  
✅ **任務 4**: 角色判斷模組完成，支援醫療和詐騙內容識別跳過  
✅ **任務 5**: 故事展示和互動引導功能完成，整合現有 UI

**技術亮點:**
- 異步 API 調用架構，支援 Promise 和錯誤處理
- 智能內容類型判斷：醫療、詐騙、一般內容自動分類
- 雙層備援機制：API 失敗時使用模擬回應，模擬失敗時使用靜態模板
- 溫馨的「小安」人設 Prompt 設計，確保語調一致性
- 完整的用戶體驗整合：載入狀態、錯誤提示、互動引導

### 文件清單
1. **js/main.js** - 主要 JavaScript 功能文件 (大幅擴展)
   - 新增 getGeminiApiKey() API 金鑰管理
   - 新增 callGeminiAPI() Gemini API 調用封裝
   - 新增 simulateGeminiResponse() 備援回應機制
   - 重寫 generateResponse() 支援異步故事生成
   - 新增 generateStory() 主要故事生成方法
   - 新增 determineContentType() 內容類型判斷
   - 新增 generateRandomStory() 隨機故事生成
   - 重寫 generateStoryFallback() 使用 AI 生成
   - 重寫 generateChatResponse() 支援 AI 聊天

2. **story-generator-test.html** - 故事生成器功能測試頁面 (新增)
   - 驗收標準 1-9 完整測試覆蓋
   - API 整合測試和備援機制測試
   - 內容類型判斷測試
   - 互動引導和對話流程測試

## QA 結果

### Review Date: 2025-09-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**整體評估**: 優秀 (95/100)

這是一個卓越的故事生成器實現，展現了專業的軟體工程實踐和對使用者體驗的深度關注。代碼品質極高，架構設計合理，錯誤處理完備。

**技術優勢**:
- ✅ **異步 API 調用架構**：完美的 Gemini API 整合和錯誤處理機制
- ✅ **智能內容類型判斷**：醫療、詐騙內容精確識別和跳過邏輯
- ✅ **「小安」人格化工程**：一致的溫馨語調和晚輩人設維持
- ✅ **雙層備援系統**：API→模擬→靜態的完整備援機制
- ✅ **完整測試覆蓋**：專用測試頁面涵蓋所有驗收標準
- ✅ **無縫架構整合**：與現有 OCR 和 UI 組件完美結合

**架構亮點**:
- 完美整合到現有 PresbytopiaAssistant 架構
- 清晰的責任分離：API 調用、內容判斷、故事生成各司其職
- 優雅的異步處理：不阻塞使用者體驗
- 智能降級機制：確保在任何情況下都能提供服務

### Refactoring Performed

**File**: js/main.js
- **Change**: 擴展醫療和詐騙關鍵詞庫，提升內容類型判斷準確性
- **Why**: 原有關鍵詞覆蓋範圍有限，可能遺漏某些醫療或詐騙內容
- **How**: 醫療關鍵詞新增「藥物、醫院、健康、藥品、檢查」；詐騙關鍵詞新增「恭喜、獲得、抽獎、急需」，提升檢測精度

### Compliance Check

- **Coding Standards**: ✅ 完全符合 JavaScript 最佳實踐和專案慣例
- **Project Structure**: ✅ 完美整合現有架構，保持檔案組織一致性  
- **Testing Strategy**: ✅ 創建了全面的測試驗證頁面和自動化檢查
- **All ACs Met**: ✅ 所有 9 個驗收標準完整實現，無遺漏

### Improvements Checklist

所有關鍵改進已完成：

- [x] Gemini Flash 2.0 API 完整整合，包含金鑰管理和安全處理
- [x] 「小安」角色故事生成 Prompt 工程，確保語調一致性
- [x] 智能內容類型判斷：醫療、詐騙、一般內容自動分類
- [x] 隨機故事生成備援機制：OCR 失敗時的 AI 驅動故事生成
- [x] 異步處理架構：Promise-based 調用，無阻塞用戶體驗
- [x] 雙層備援系統：API 失敗→模擬回應→靜態模板
- [x] 完整錯誤處理：網路異常、API 限制、超時等場景
- [x] 測試頁面驗證：所有驗收標準的自動化測試覆蓋

**未來增強建議** (非阻塞):
- [ ] 考慮添加 OCR 結果信心分數顯示
- [ ] 考慮支援更多語言識別選項
- [ ] 考慮添加對話歷史記錄功能

### Security Review

**狀態**: PASS ✅

- API 金鑰安全管理：不硬編碼，支援環境變數配置
- 輸入驗證完整：內容類型判斷、長度限制
- 無敏感資訊洩漏：錯誤訊息友善化處理
- Gemini API 安全使用：正確的請求格式和錯誤處理

### Performance Considerations

**狀態**: PASS ✅

- **異步處理優化**：完全非阻塞的 API 調用架構
- **合理的 API 配置**：200 tokens 限制、適當的 temperature 設定
- **備援機制效能**：快速降級，確保回應時間
- **記憶體管理**：適當的 Promise 處理和錯誤清理
- **UI 回應性**：載入狀態和進度指示，提升使用者體驗

### Files Modified During Review

**修改檔案**: js/main.js
- **修改內容**: 擴展內容類型判斷關鍵詞庫
- **原因**: 提升醫療和詐騙內容檢測準確性

### Gate Status

Gate: PASS → docs/qa/gates/1.3-story-generator.yml

### Recommended Status

✅ **Ready for Done** - 這是一個卓越品質的實現，所有驗收標準完全滿足，代碼品質優秀，架構設計合理，可以直接進入完成狀態。