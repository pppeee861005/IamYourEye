<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è§’è‰²åˆ‡æ›ç³»çµ±æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .test-result {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
            border-radius: 4px;
        }
        .test-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .role-demo {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>æ•…äº‹ 2.1: AI è§’è‰²åˆ‡æ›ç³»çµ±æ¸¬è©¦</h1>

    <div class="test-section">
        <h2>é©—æ”¶æ¨™æº– 1-9: è§’è‰²åˆ‡æ›åŠŸèƒ½æ¸¬è©¦</h2>
        <button class="test-button" onclick="testDefaultRole()">æ¸¬è©¦é è¨­å°å®‰è§’è‰²</button>
        <button class="test-button" onclick="testMedicalRole()">æ¸¬è©¦æ™ºèƒ½é†«å¸«è§’è‰²</button>
        <button class="test-button" onclick="testAntifraudRole()">æ¸¬è©¦é˜²è©è­¦å¯Ÿè§’è‰²</button>
        <button class="test-button" onclick="testRoleSwitching()">æ¸¬è©¦è‡ªå‹•è§’è‰²åˆ‡æ›</button>
        <div id="basic-test-results"></div>
    </div>

    <div class="test-section">
        <h2>è§’è‰²æŒ‡ç¤ºå™¨æ¸¬è©¦</h2>
        <button class="test-button" onclick="testRoleIndicator()">æ¸¬è©¦è§’è‰²æŒ‡ç¤ºå™¨æ›´æ–°</button>
        <div id="indicator-results"></div>
    </div>

    <div class="test-section">
        <h2>å¤šè¼ªå°è©±æ¸¬è©¦</h2>
        <button class="test-button" onclick="testConversationFlow()">æ¸¬è©¦å°è©±æµç¨‹</button>
        <button class="test-button" onclick="testRoleConsistency()">æ¸¬è©¦è§’è‰²ä¸€è‡´æ€§</button>
        <div id="conversation-results"></div>
    </div>

    <div class="test-section">
        <h2>System Prompt æ¸¬è©¦</h2>
        <button class="test-button" onclick="testSystemPrompts()">æ¸¬è©¦å„è§’è‰² Prompt</button>
        <button class="test-button" onclick="testMedicalConstraints()">æ¸¬è©¦é†«å¸«ã€Œä¸‰ä¸ä¸€å»£æ³›ã€åŸå‰‡</button>
        <div id="prompt-results"></div>
    </div>

    <!-- è§’è‰²ç¤ºç¯„å€åŸŸ -->
    <div class="test-section">
        <h2>è§’è‰²åˆ‡æ›ç¤ºç¯„</h2>
        <div id="role-demo-area">
            <div class="role-demo">
                <h4>ç•¶å‰è§’è‰²ï¼š<span id="current-role-name">è¼‰å…¥ä¸­...</span></h4>
                <p><strong>è§’è‰²æè¿°ï¼š</strong><span id="role-description">è¼‰å…¥ä¸­...</span></p>
                <p><strong>System Promptï¼š</strong><span id="role-prompt">è¼‰å…¥ä¸­...</span></p>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥ä¸»è¦çš„ JavaScript -->
    <script src="js/main.js"></script>

    <script>
        let assistant;
        let roleManager;

        // åˆå§‹åŒ–æ¸¬è©¦ç’°å¢ƒ
        document.addEventListener('DOMContentLoaded', function() {
            assistant = new PresbytopiaAssistant();
            roleManager = assistant.roleManager;
            
            updateRoleDemo();
            console.log('âœ… è§’è‰²åˆ‡æ›æ¸¬è©¦ç’°å¢ƒåˆå§‹åŒ–å®Œæˆ');
        });

        function showResult(containerId, message, isError = false) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = isError ? 'test-result test-error' : 'test-result';
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            container.appendChild(div);
        }

        function showLoading(containerId, message) {
            showResult(containerId, `<span class="loading">${message}</span>`);
        }

        function updateRoleDemo() {
            const currentRole = roleManager.getCurrentRole();
            if (currentRole) {
                document.getElementById('current-role-name').textContent = currentRole.displayName;
                document.getElementById('role-description').textContent = `${currentRole.name} (${currentRole.type})`;
                document.getElementById('role-prompt').textContent = currentRole.systemPrompt.substring(0, 150) + '...';
            }
        }

        // æ¸¬è©¦é è¨­å°å®‰è§’è‰²
        async function testDefaultRole() {
            const containerId = 'basic-test-results';
            showLoading(containerId, 'æ¸¬è©¦é è¨­å°å®‰è§’è‰²ä¸­...');

            try {
                roleManager.resetToDefault();
                const currentRole = roleManager.getCurrentRole();
                const pass = currentRole.name === 'å°å®‰' && currentRole.type === 'companion';
                
                showResult(containerId, 
                    `é è¨­è§’è‰²æ¸¬è©¦ ${pass ? 'é€šé' : 'å¤±æ•—'}: ç•¶å‰è§’è‰²ç‚º ${currentRole.displayName}`, !pass);

                // æ¸¬è©¦å°å®‰çš„å›æ‡‰
                const response = await assistant.generateChatResponse('ä»Šå¤©å¤©æ°£çœŸå¥½');
                const hasWarmth = response.content && response.content.length > 0;
                
                showResult(containerId, 
                    `å°å®‰å›æ‡‰æ¸¬è©¦ ${hasWarmth ? 'é€šé' : 'å¤±æ•—'}: ${response.content}`, !hasWarmth);
                
                updateRoleDemo();
                    
            } catch (error) {
                showResult(containerId, `é è¨­è§’è‰²æ¸¬è©¦å¤±æ•—: ${error.message}`, true);
            }
        }

        // æ¸¬è©¦æ™ºèƒ½é†«å¸«è§’è‰²
        async function testMedicalRole() {
            const containerId = 'basic-test-results';
            showLoading(containerId, 'æ¸¬è©¦æ™ºèƒ½é†«å¸«è§’è‰²ä¸­...');

            try {
                const medicalMessage = 'æˆ‘æƒ³å•ä¸€ä¸‹é€™å€‹è—¥å“çš„ä½¿ç”¨æ–¹æ³•';
                const response = await assistant.generateChatResponse(medicalMessage);
                
                const currentRole = roleManager.getCurrentRole();
                const rolePass = currentRole.name === 'æ™ºèƒ½é†«å¸«';
                const constraintPass = !response.content.includes('åŠ‘é‡') && 
                                     !response.content.includes('è¨ºæ–·') &&
                                     response.content.includes('é†«å¸«');
                
                showResult(containerId, 
                    `é†«å¸«è§’è‰²åˆ‡æ› ${rolePass ? 'é€šé' : 'å¤±æ•—'}: ç•¶å‰è§’è‰² ${currentRole.displayName}`, !rolePass);
                
                showResult(containerId, 
                    `ã€Œä¸‰ä¸ä¸€å»£æ³›ã€åŸå‰‡ ${constraintPass ? 'é€šé' : 'å¤±æ•—'}: ${response.content}`, !constraintPass);
                
                updateRoleDemo();
                    
            } catch (error) {
                showResult(containerId, `é†«å¸«è§’è‰²æ¸¬è©¦å¤±æ•—: ${error.message}`, true);
            }
        }

        // æ¸¬è©¦é˜²è©è­¦å¯Ÿè§’è‰²
        async function testAntifraudRole() {
            const containerId = 'basic-test-results';
            showLoading(containerId, 'æ¸¬è©¦é˜²è©è­¦å¯Ÿè§’è‰²ä¸­...');

            try {
                const fraudMessage = 'æ­å–œæ‚¨ä¸­çäº†ï¼è«‹ç«‹å³åŒ¯æ¬¾é ˜å–çé‡‘';
                const response = await assistant.generateChatResponse(fraudMessage);
                
                const currentRole = roleManager.getCurrentRole();
                const rolePass = currentRole.name === 'æ™ºèƒ½é˜²è©è­¦å¯Ÿ';
                const warningPass = response.content.includes('å¯ç–‘') || 
                                   response.content.includes('è©é¨™') ||
                                   response.content.includes('165');
                
                showResult(containerId, 
                    `é˜²è©è§’è‰²åˆ‡æ› ${rolePass ? 'é€šé' : 'å¤±æ•—'}: ç•¶å‰è§’è‰² ${currentRole.displayName}`, !rolePass);
                
                showResult(containerId, 
                    `è©é¨™è­¦å‘ŠåŠŸèƒ½ ${warningPass ? 'é€šé' : 'å¤±æ•—'}: ${response.content}`, !warningPass);
                
                updateRoleDemo();
                    
            } catch (error) {
                showResult(containerId, `é˜²è©è§’è‰²æ¸¬è©¦å¤±æ•—: ${error.message}`, true);
            }
        }

        // æ¸¬è©¦è‡ªå‹•è§’è‰²åˆ‡æ›
        async function testRoleSwitching() {
            const containerId = 'basic-test-results';
            showLoading(containerId, 'æ¸¬è©¦è‡ªå‹•è§’è‰²åˆ‡æ›ä¸­...');

            try {
                const testCases = [
                    { message: 'ä»Šå¤©å¤©æ°£å¾ˆå¥½', expectedRole: 'å°å®‰' },
                    { message: 'æˆ‘æƒ³äº†è§£é€™å€‹è—¥ç‰©', expectedRole: 'æ™ºèƒ½é†«å¸«' },
                    { message: 'æ”¶åˆ°ä¸­çç°¡è¨Š', expectedRole: 'æ™ºèƒ½é˜²è©è­¦å¯Ÿ' },
                    { message: 'è¬è¬ä½ çš„å¹«åŠ©', expectedRole: 'å°å®‰' }
                ];

                for (const testCase of testCases) {
                    const response = await assistant.generateChatResponse(testCase.message);
                    const currentRole = roleManager.getCurrentRole();
                    const pass = currentRole.name === testCase.expectedRole;
                    
                    showResult(containerId, 
                        `"${testCase.message}" â†’ ${currentRole.name} ${pass ? 'âœ“' : 'âœ—'}`, !pass);
                }

                updateRoleDemo();
                
            } catch (error) {
                showResult(containerId, `è§’è‰²åˆ‡æ›æ¸¬è©¦å¤±æ•—: ${error.message}`, true);
            }
        }

        // æ¸¬è©¦è§’è‰²æŒ‡ç¤ºå™¨
        async function testRoleIndicator() {
            const containerId = 'indicator-results';
            showLoading(containerId, 'æ¸¬è©¦è§’è‰²æŒ‡ç¤ºå™¨ä¸­...');

            try {
                const indicator = document.getElementById('role-indicator');
                const hasIndicator = indicator !== null;
                
                showResult(containerId, 
                    `è§’è‰²æŒ‡ç¤ºå™¨å­˜åœ¨ ${hasIndicator ? 'é€šé' : 'å¤±æ•—'}`, !hasIndicator);

                if (hasIndicator) {
                    // æ¸¬è©¦æŒ‡ç¤ºå™¨æ›´æ–°
                    roleManager.switchRole('doctor');
                    assistant.updateRoleIndicator();
                    
                    const indicatorText = indicator.textContent;
                    const hasCorrectText = indicatorText.includes('æ™ºèƒ½é†«å¸«');
                    
                    showResult(containerId, 
                        `æŒ‡ç¤ºå™¨æ›´æ–° ${hasCorrectText ? 'é€šé' : 'å¤±æ•—'}: ${indicatorText}`, !hasCorrectText);
                    
                    // æ¸¬è©¦æ¨£å¼è®ŠåŒ–
                    const hasCorrectClass = indicator.className.includes('role-medical');
                    showResult(containerId, 
                        `æ¨£å¼æ›´æ–° ${hasCorrectClass ? 'é€šé' : 'å¤±æ•—'}: ${indicator.className}`, !hasCorrectClass);
                }
                
                updateRoleDemo();
                    
            } catch (error) {
                showResult(containerId, `è§’è‰²æŒ‡ç¤ºå™¨æ¸¬è©¦å¤±æ•—: ${error.message}`, true);
            }
        }

        // æ¸¬è©¦å°è©±æµç¨‹
        async function testConversationFlow() {
            const containerId = 'conversation-results';
            showLoading(containerId, 'æ¸¬è©¦å°è©±æµç¨‹ä¸­...');

            try {
                // é‡ç½®åˆ°é è¨­è§’è‰²
                roleManager.resetToDefault();
                
                // æ¨¡æ“¬å¤šè¼ªå°è©±
                const conversation = [
                    'ä½ å¥½å°å®‰',
                    'æˆ‘èº«é«”ä¸å¤ªèˆ’æœ',
                    'æ”¶åˆ°ä¸€å°å¥‡æ€ªçš„ä¿¡',
                    'è¬è¬ä½ çš„å¹«åŠ©'
                ];

                for (const message of conversation) {
                    const response = await assistant.generateChatResponse(message);
                    const currentRole = roleManager.getCurrentRole();
                    
                    showResult(containerId, 
                        `"${message}" â†’ ${currentRole.name}: ${response.content.substring(0, 50)}...`);
                    
                    // çŸ­æš«å»¶é²æ¨¡æ“¬çœŸå¯¦å°è©±
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                updateRoleDemo();
                
            } catch (error) {
                showResult(containerId, `å°è©±æµç¨‹æ¸¬è©¦å¤±æ•—: ${error.message}`, true);
            }
        }

        // æ¸¬è©¦è§’è‰²ä¸€è‡´æ€§
        async function testRoleConsistency() {
            const containerId = 'conversation-results';
            showLoading(containerId, 'æ¸¬è©¦è§’è‰²ä¸€è‡´æ€§ä¸­...');

            try {
                // è¨­å®šç‚ºé†«å¸«è§’è‰²
                roleManager.switchRole('doctor');
                assistant.updateRoleIndicator();
                
                const medicalQuestions = [
                    'é€™å€‹è—¥æ€éº¼åƒï¼Ÿ',
                    'æˆ‘å¯ä»¥è¨ºæ–·ç–¾ç—…å—ï¼Ÿ',
                    'å¥åº·é£²é£Ÿçš„å»ºè­°'
                ];

                let consistencyPass = true;
                
                for (const question of medicalQuestions) {
                    const response = await assistant.generateRoleBasedResponse(question);
                    const currentRole = roleManager.getCurrentRole();
                    
                    // æª¢æŸ¥æ˜¯å¦ç¶­æŒé†«å¸«è§’è‰²
                    if (currentRole.name !== 'æ™ºèƒ½é†«å¸«') {
                        consistencyPass = false;
                    }
                    
                    // æª¢æŸ¥æ˜¯å¦éµå®ˆä¸‰ä¸åŸå‰‡
                    const violatesConstraints = response.content.includes('è¨ºæ–·') || 
                                               response.content.includes('åŠ‘é‡') ||
                                               response.content.includes('åƒ');
                    
                    showResult(containerId, 
                        `"${question}" ç´„æŸæª¢æŸ¥ ${violatesConstraints ? 'å¤±æ•—' : 'é€šé'}`, violatesConstraints);
                }
                
                showResult(containerId, 
                    `è§’è‰²ä¸€è‡´æ€§ ${consistencyPass ? 'é€šé' : 'å¤±æ•—'}`, !consistencyPass);
                
                updateRoleDemo();
                
            } catch (error) {
                showResult(containerId, `è§’è‰²ä¸€è‡´æ€§æ¸¬è©¦å¤±æ•—: ${error.message}`, true);
            }
        }

        // æ¸¬è©¦ System Prompts
        async function testSystemPrompts() {
            const containerId = 'prompt-results';
            showLoading(containerId, 'æ¸¬è©¦ System Prompts ä¸­...');

            try {
                const roles = ['xiaoan', 'doctor', 'antifraud'];
                
                for (const roleId of roles) {
                    const prompt = roleManager.getRolePrompt(roleId);
                    const hasPrompt = prompt && prompt.length > 50;
                    const roleName = roleManager.roles[roleId].name;
                    
                    showResult(containerId, 
                        `${roleName} System Prompt ${hasPrompt ? 'é€šé' : 'å¤±æ•—'}: é•·åº¦ ${prompt.length} å­—ç¬¦`, !hasPrompt);
                }
                
            } catch (error) {
                showResult(containerId, `System Prompt æ¸¬è©¦å¤±æ•—: ${error.message}`, true);
            }
        }

        // æ¸¬è©¦é†«å¸«ç´„æŸ
        async function testMedicalConstraints() {
            const containerId = 'prompt-results';
            showLoading(containerId, 'æ¸¬è©¦é†«å¸«ç´„æŸåŸå‰‡ä¸­...');

            try {
                roleManager.switchRole('doctor');
                const prompt = roleManager.getRolePrompt();
                
                // æª¢æŸ¥ prompt æ˜¯å¦åŒ…å«ç´„æŸæ¢ä»¶
                const hasConstraints = prompt.includes('ä¸‰ä¸ä¸€å»£æ³›') || 
                                      (prompt.includes('ä¸è¨ºæ–·') && 
                                       prompt.includes('ä¸å»ºè­°') && 
                                       prompt.includes('ä¸è¨è«–è—¥å“'));
                
                showResult(containerId, 
                    `é†«å¸«ç´„æŸåŸå‰‡ ${hasConstraints ? 'é€šé' : 'å¤±æ•—'}: Prompt åŒ…å«ç´„æŸæ¢ä»¶`, !hasConstraints);
                
                updateRoleDemo();
                
            } catch (error) {
                showResult(containerId, `é†«å¸«ç´„æŸæ¸¬è©¦å¤±æ•—: ${error.message}`, true);
            }
        }

        // é‹è¡Œæ‰€æœ‰æ¸¬è©¦
        function runAllTests() {
            setTimeout(() => testDefaultRole(), 100);
            setTimeout(() => testMedicalRole(), 2000);
            setTimeout(() => testAntifraudRole(), 4000);
            setTimeout(() => testRoleSwitching(), 6000);
            setTimeout(() => testRoleIndicator(), 8000);
            setTimeout(() => testSystemPrompts(), 9000);
            setTimeout(() => testMedicalConstraints(), 10000);
            setTimeout(() => testConversationFlow(), 11000);
            setTimeout(() => testRoleConsistency(), 15000);
        }

        // åœ¨é é¢è¼‰å…¥å®Œæˆå¾Œé¡¯ç¤ºå¿«é€Ÿæ¸¬è©¦æŒ‰éˆ•
        document.addEventListener('DOMContentLoaded', function() {
            const button = document.createElement('button');
            button.className = 'test-button';
            button.textContent = 'ğŸš€ é‹è¡Œæ‰€æœ‰æ¸¬è©¦';
            button.onclick = runAllTests;
            button.style.fontSize = '16px';
            button.style.padding = '15px 30px';
            document.body.insertBefore(button, document.body.firstChild);
        });
    </script>
</body>
</html>